import Foundation
import MapKit
import SwiftUI

// MARK: - Property Annotation

/// Custom annotation for displaying properties on the map
class PropertyAnnotation: NSObject, MKAnnotation {
    let property: Property

    var coordinate: CLLocationCoordinate2D {
        property.coordinate ?? CLLocationCoordinate2D(latitude: 0, longitude: 0)
    }

    var title: String? {
        property.title
    }

    var subtitle: String? {
        "\(property.monthlyRent)€/mois"
    }

    init(property: Property) {
        self.property = property
        super.init()
    }
}

// MARK: - Property Annotation View

/// Custom annotation view matching web app design
class PropertyAnnotationView: MKAnnotationView {

    // MARK: - Properties

    private let markerSize: CGFloat = 40
    private let imageSize: CGFloat = 120
    private let cardHeight: CGFloat = 90

    override var isSelected: Bool {
        didSet {
            updateAppearance()
        }
    }

    // MARK: - UI Components

    private lazy var pinView: UIView = {
        let view = UIView()
        view.backgroundColor = Theme.ResidentColors._400.uiColor
        view.layer.cornerRadius = markerSize / 2
        view.translatesAutoresizingMaskIntoConstraints = false
        return view
    }()

    private lazy var iconImageView: UIImageView = {
        let imageView = UIImageView()
        imageView.image = UIImage(systemName: "mappin.circle.fill")
        imageView.tintColor = .white
        imageView.contentMode = .scaleAspectFit
        imageView.translatesAutoresizingMaskIntoConstraints = false
        return imageView
    }()

    private lazy var cardContainerView: UIView = {
        let view = UIView()
        view.backgroundColor = .white
        view.layer.cornerRadius = Theme.CornerRadius.lg
        view.layer.shadowColor = UIColor.black.cgColor
        view.layer.shadowOffset = CGSize(width: 0, height: 4)
        view.layer.shadowRadius = 8
        view.layer.shadowOpacity = 0.15
        view.clipsToBounds = false
        view.translatesAutoresizingMaskIntoConstraints = false
        view.isHidden = true
        return view
    }()

    private lazy var propertyImageView: UIImageView = {
        let imageView = UIImageView()
        imageView.contentMode = .scaleAspectFill
        imageView.clipsToBounds = true
        imageView.layer.cornerRadius = Theme.CornerRadius.md
        imageView.translatesAutoresizingMaskIntoConstraints = false
        return imageView
    }()

    private lazy var priceLabel: UILabel = {
        let label = UILabel()
        label.font = Theme.Typography.bodySmall(.bold).uiFont
        label.textColor = Theme.ResidentColors._700.uiColor
        label.textAlignment = .center
        label.backgroundColor = UIColor.white.withAlphaComponent(0.95)
        label.layer.cornerRadius = Theme.CornerRadius.full
        label.clipsToBounds = true
        label.translatesAutoresizingMaskIntoConstraints = false
        return label
    }()

    private lazy var pointerView: UIView = {
        let view = TriangleView()
        view.fillColor = .white
        view.translatesAutoresizingMaskIntoConstraints = false
        return view
    }()

    // MARK: - Initialization

    override init(annotation: MKAnnotation?, reuseIdentifier: String?) {
        super.init(annotation: annotation, reuseIdentifier: reuseIdentifier)
        setupView()
    }

    required init?(coder aDecoder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }

    // MARK: - Setup

    private func setupView() {
        // Configure annotation view
        frame = CGRect(x: 0, y: 0, width: imageSize, height: cardHeight + markerSize)
        backgroundColor = .clear

        // Add subviews
        addSubview(cardContainerView)
        addSubview(pinView)
        pinView.addSubview(iconImageView)
        cardContainerView.addSubview(propertyImageView)
        cardContainerView.addSubview(priceLabel)
        cardContainerView.addSubview(pointerView)

        // Setup constraints
        setupConstraints()
    }

    private func setupConstraints() {
        // Pin view (bottom center)
        NSLayoutConstraint.activate([
            pinView.centerXAnchor.constraint(equalTo: centerXAnchor),
            pinView.bottomAnchor.constraint(equalTo: bottomAnchor),
            pinView.widthAnchor.constraint(equalToConstant: markerSize),
            pinView.heightAnchor.constraint(equalToConstant: markerSize)
        ])

        // Icon inside pin
        NSLayoutConstraint.activate([
            iconImageView.centerXAnchor.constraint(equalTo: pinView.centerXAnchor),
            iconImageView.centerYAnchor.constraint(equalTo: pinView.centerYAnchor),
            iconImageView.widthAnchor.constraint(equalToConstant: markerSize * 0.6),
            iconImageView.heightAnchor.constraint(equalToConstant: markerSize * 0.6)
        ])

        // Card container
        NSLayoutConstraint.activate([
            cardContainerView.centerXAnchor.constraint(equalTo: centerXAnchor),
            cardContainerView.bottomAnchor.constraint(equalTo: pinView.topAnchor, constant: -8),
            cardContainerView.widthAnchor.constraint(equalToConstant: imageSize),
            cardContainerView.heightAnchor.constraint(equalToConstant: cardHeight)
        ])

        // Property image
        NSLayoutConstraint.activate([
            propertyImageView.topAnchor.constraint(equalTo: cardContainerView.topAnchor, constant: 8),
            propertyImageView.leadingAnchor.constraint(equalTo: cardContainerView.leadingAnchor, constant: 8),
            propertyImageView.trailingAnchor.constraint(equalTo: cardContainerView.trailingAnchor, constant: -8),
            propertyImageView.bottomAnchor.constraint(equalTo: priceLabel.topAnchor, constant: -8)
        ])

        // Price label
        NSLayoutConstraint.activate([
            priceLabel.leadingAnchor.constraint(equalTo: cardContainerView.leadingAnchor, constant: 12),
            priceLabel.trailingAnchor.constraint(equalTo: cardContainerView.trailingAnchor, constant: -12),
            priceLabel.bottomAnchor.constraint(equalTo: cardContainerView.bottomAnchor, constant: -8),
            priceLabel.heightAnchor.constraint(equalToConstant: 24)
        ])

        // Pointer (triangle)
        NSLayoutConstraint.activate([
            pointerView.centerXAnchor.constraint(equalTo: cardContainerView.centerXAnchor),
            pointerView.topAnchor.constraint(equalTo: cardContainerView.bottomAnchor),
            pointerView.widthAnchor.constraint(equalToConstant: 16),
            pointerView.heightAnchor.constraint(equalToConstant: 8)
        ])
    }

    // MARK: - Configuration

    func configure(with property: Property, isSelected: Bool) {
        self.isSelected = isSelected

        // Load property image
        if let imageUrl = property.mainImageURL, let url = URL(string: imageUrl) {
            URLSession.shared.dataTask(with: url) { [weak self] data, _, _ in
                if let data = data, let image = UIImage(data: data) {
                    DispatchQueue.main.async {
                        self?.propertyImageView.image = image
                    }
                }
            }.resume()
        } else {
            propertyImageView.image = UIImage(systemName: "house.fill")
            propertyImageView.tintColor = Theme.GrayColors._300.uiColor
        }

        // Set price
        priceLabel.text = "\(property.monthlyRent)€/mois"

        updateAppearance()
    }

    private func updateAppearance() {
        UIView.animate(withDuration: Theme.Animations.base.duration) {
            if self.isSelected {
                // Show card, enlarge pin
                self.cardContainerView.isHidden = false
                self.pinView.transform = CGAffineTransform(scaleX: 1.25, y: 1.25)
                self.pinView.backgroundColor = Theme.ResidentColors._600.uiColor
                self.pinView.layer.shadowColor = UIColor.black.cgColor
                self.pinView.layer.shadowOffset = CGSize(width: 0, height: 4)
                self.pinView.layer.shadowRadius = 8
                self.pinView.layer.shadowOpacity = 0.3
            } else {
                // Hide card, normal pin
                self.cardContainerView.isHidden = true
                self.pinView.transform = .identity
                self.pinView.backgroundColor = Theme.ResidentColors._400.uiColor
                self.pinView.layer.shadowOpacity = 0.15
            }
        }
    }

    // MARK: - Selection

    override func setSelected(_ selected: Bool, animated: Bool) {
        super.setSelected(selected, animated: animated)

        if animated {
            UIView.animate(withDuration: Theme.Animations.base.duration) {
                self.isSelected = selected
            }
        } else {
            isSelected = selected
        }
    }
}

// MARK: - Triangle View for Pointer

private class TriangleView: UIView {
    var fillColor: UIColor = .white {
        didSet {
            setNeedsDisplay()
        }
    }

    override func draw(_ rect: CGRect) {
        guard let context = UIGraphicsGetCurrentContext() else { return }

        context.beginPath()
        context.move(to: CGPoint(x: rect.midX, y: rect.maxY))
        context.addLine(to: CGPoint(x: rect.minX, y: rect.minY))
        context.addLine(to: CGPoint(x: rect.maxX, y: rect.minY))
        context.closePath()

        context.setFillColor(fillColor.cgColor)
        context.fillPath()
    }
}

// MARK: - Theme Extensions for UIKit

extension Theme.Shadow {
    var cgFloat: CGFloat {
        return radius
    }
}

extension Theme.CornerRadius {
    var cgFloat: CGFloat {
        switch self {
        case Theme.CornerRadius.sm: return 6
        case Theme.CornerRadius.md: return 8
        case Theme.CornerRadius.lg: return 12
        case Theme.CornerRadius.xl: return 16
        case Theme.CornerRadius._2xl: return 24
        case Theme.CornerRadius._3xl: return 32
        case Theme.CornerRadius.full: return 9999
        default: return 8
        }
    }
}

extension Color {
    var uiColor: UIColor {
        UIColor(self)
    }
}

extension Font {
    var uiFont: UIFont {
        // Convert SwiftUI Font to UIFont (approximate)
        return UIFont.systemFont(ofSize: 14) // Default, would need proper conversion
    }
}

extension Theme.Animations {
    var duration: TimeInterval {
        if self == Theme.Animations.fast { return 0.15 }
        if self == Theme.Animations.base { return 0.2 }
        if self == Theme.Animations.slow { return 0.3 }
        return 0.2
    }
}
